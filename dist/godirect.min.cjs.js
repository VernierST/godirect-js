/**
 * Copyright (c) 2020 Vernier Software. All rights reserved.
 * This code may only be used under the BSD 3-Clause license found at
 * https://raw.githubusercontent.com/VernierST/godirect-js/master/LICENSE
 */

"use strict";var runtime=function(e){var t,n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(e,t,n,r){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new A(r||[]);return o._invoke=function(e,t,n){var r=l;return function(a,o){if(r===f)throw new Error("Generator is already running");if(r===p){if("throw"===a)throw o;return C()}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var s=S(i,n);if(s){if(s===m)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===l)throw r=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=f;var u=c(e,t,n);if("normal"===u.type){if(r=n.done?p:h,u.arg===m)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=p,n.method="throw",n.arg=u.arg)}}}(e,n,i),o}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l="suspendedStart",h="suspendedYield",f="executing",p="completed",m={};function d(){}function v(){}function g(){}var y={};y[o]=function(){return this};var _=Object.getPrototypeOf,E=_&&_(_(x([])));E&&E!==n&&r.call(E,o)&&(y=E);var b=g.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function R(e){var t;this._invoke=function(n,a){function o(){return new Promise(function(t,o){!function t(n,a,o,i){var s=c(e[n],e,a);if("throw"!==s.type){var u=s.arg,l=u.value;return l&&"object"==typeof l&&r.call(l,"__await")?Promise.resolve(l.__await).then(function(e){t("next",e,o,i)},function(e){t("throw",e,o,i)}):Promise.resolve(l).then(function(e){u.value=e,o(u)},function(e){return t("throw",e,o,i)})}i(s.arg)}(n,a,t,o)})}return t=t?t.then(o,o):o()}}function S(e,n){var r=e.iterator[n.method];if(r===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,S(e,n),"throw"===n.method))return m;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var a=c(r,e.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var o=a.arg;return o?o.done?(n[e.resultName]=o.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function x(e){if(e){var n=e[o];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function n(){for(;++a<e.length;)if(r.call(e,a))return n.value=e[a],n.done=!1,n;return n.value=t,n.done=!0,n};return i.next=i}}return{next:C}}function C(){return{value:t,done:!0}}return v.prototype=b.constructor=g,g.constructor=v,g[s]=v.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(R.prototype),R.prototype[i]=function(){return this},e.AsyncIterator=R,e.async=function(t,n,r,a){var o=new R(u(t,n,r,a));return e.isGeneratorFunction(n)?o:o.next().then(function(e){return e.done?e.value:o.next()})},w(b),b[s]="Generator",b[o]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=x,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function a(r,a){return s.type="throw",s.arg=e,n.next=r,a&&(n.method="next",n.arg=t),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var u=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;k(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:x(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}("object"==typeof module?module.exports:{});try{regeneratorRuntime=runtime}catch(e){Function("r","regeneratorRuntime = r")(runtime)}function asyncGeneratorStep(e,t,n,r,a,o,i){try{var s=e[o](i),u=s.value}catch(e){return void n(e)}s.done?t(u):Promise.resolve(u).then(r,a)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var o=e.apply(t,n);function i(e){asyncGeneratorStep(o,r,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,r,a,i,s,"throw",e)}i(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var HEADER=new Uint8Array([88,0,0,0]),INIT=new Uint8Array([26,165,74,6,73,7,72,8,71,9,70,10,69,11,68,12,67,13,66,14,65]),START_MEASUREMENTS=new Uint8Array([24,255,1,0,0,0,0,0,0,0,0,0,0,0,0]),STOP_MEASUREMENTS=new Uint8Array([25,255,0,255,255,255,255]),SET_MEASUREMENT_PERIOD=new Uint8Array([27,255,0,0,0,0,0,0,0,0,0]),DISCONNECT=new Uint8Array([84]),GET_INFO=new Uint8Array([85]),GET_STATUS=new Uint8Array([16]),GET_SENSOR_IDS=new Uint8Array([81]),GET_SENSOR_INFO=new Uint8Array([80,0]),GET_DEFAULT_SENSORS_MASK=new Uint8Array([86]),commands={HEADER:HEADER,INIT:INIT,DISCONNECT:DISCONNECT,START_MEASUREMENTS:START_MEASUREMENTS,STOP_MEASUREMENTS:STOP_MEASUREMENTS,SET_MEASUREMENT_PERIOD:SET_MEASUREMENT_PERIOD,GET_INFO:GET_INFO,GET_STATUS:GET_STATUS,GET_SENSOR_IDS:GET_SENSOR_IDS,GET_SENSOR_INFO:GET_SENSOR_INFO,GET_DEFAULT_SENSORS_MASK:GET_DEFAULT_SENSORS_MASK},NORMAL_REAL32=6,WIDE_REAL32=7,APERIODIC_REAL32=10,SINGLE_CHANNEL_REAL32=8,SINGLE_CHANNEL_INT32=9,APERIODIC_INT32=11,START_TIME=12,DROPPED=13,PERIOD=14,measurementType={NORMAL_REAL32:NORMAL_REAL32,WIDE_REAL32:WIDE_REAL32,APERIODIC_REAL32:APERIODIC_REAL32,SINGLE_CHANNEL_REAL32:SINGLE_CHANNEL_REAL32,SINGLE_CHANNEL_INT32:SINGLE_CHANNEL_INT32,APERIODIC_INT32:APERIODIC_INT32,START_TIME:START_TIME,DROPPED:DROPPED,PERIOD:PERIOD},MEASUREMENT=32,responseType={MEASUREMENT:MEASUREMENT},isFunction=function(e){return"function"==typeof e||!1},nonZero=function(e){return 0!==e},EventEmitter=function(){function e(){_classCallCheck(this,e),this._listenerMap=new Map}return _createClass(e,[{key:"on",value:function(e,t){this._listenerMap.has(e)||this._listenerMap.set(e,[]),this._listenerMap.get(e).push(t)}},{key:"off",value:function(e,t){var n=this._listenerMap.get(e);if(n&&n.length){var r=n.reduce(function(e,n,r){return isFunction(n)&&n===t?e=r:e},-1);if(r>-1)return n.splice(r,1),this._listenerMap.set(e,n),!0}return!1}},{key:"unbind",value:function(){this._listenerMap.clear()}},{key:"emit",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=this._listenerMap.get(e);return!(!a||!a.length)&&(a.forEach(function(e){e.apply(void 0,n)}),!0)}}]),e}(),log=function(){},dir=function(){};function bufferToHex(e){return Array.from(new Uint8Array(e)).map(function(e){return e.toString(16).padStart(2,"0")}).join(" ")}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}var _TextDecoder,MeasurementInfo=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.type=t.type,this.mode=t.mode,this.minValue=t.minValue,this.maxValue=t.maxValue,this.uncertainty=t.uncertainty,this.minPeriod=t.minPeriod,this.maxPeriod=t.maxPeriod,this.typicalPeriod=t.typicalPeriod,this.granularity=t.granularity},SensorSpecs=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.number=t.number,this.name=t.name,this.unit=t.unit,this.id=t.id,this.mutalExclusionMask=t.mutalExclusionMask,this.measurementInfo=t.measurementInfo},Sensor=function(e){function t(e){var n;return _classCallCheck(this,t),(n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).number=e.number,n.name=e.name,n.unit=e.unit,n.specs=e,n.enabled=!1,n.values=[],n.value=null,n}return _inherits(t,EventEmitter),_createClass(t,[{key:"clear",value:function(){this.value=null,this.values=[]}},{key:"setValue",value:function(e,t){this.value=e,t&&this.values.push(this.value),this.emit("value-changed",this)}},{key:"setEnabled",value:function(e){this.enabled!==e&&(this.enabled=e,this.emit("state-changed",this))}}]),t}(),Device=function(e){function t(e){var n;if(_classCallCheck(this,t),n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"undefined"==typeof TextDecoder){var r=require("text-encoding");_TextDecoder=r.TextDecoder}else _TextDecoder=TextDecoder;return n.device=e,n.sensors=[],n.opened=!1,n.rollingCounter=0,n.collecting=!1,n.measurementPeriod=10,n.response=null,n.remainingResponseLength=0,n.defaultSensorsMask=0,n.keepValues=!0,n.minMeasurementPeriod=10,n.serialNumber="",n.orderCode="",n.name="",n}var n,r,a,o,i,s,u,c,l,h,f;return _inherits(t,EventEmitter),_createClass(t,[{key:"getBatteryLevel",value:(f=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getStatus();case 2:return t=e.sent,e.abrupt("return",t.battery);case 4:case"end":return e.stop()}},e,this)})),function(){return f.apply(this,arguments)})},{key:"getChargingState",value:(h=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getStatus();case 2:return t=e.sent,e.abrupt("return",t.chargingStatus);case 4:case"end":return e.stop()}},e,this)})),function(){return h.apply(this,arguments)})},{key:"open",value:(l=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.length>0&&void 0!==n[0]&&n[0],!this.opened){e.next=3;break}throw new Error("Device cannot be opened because it is already open");case 3:return e.next=5,this._connect();case 5:return e.next=7,this._init();case 7:return e.next=9,this._getStatus();case 9:return e.next=11,this._getDeviceInfo();case 11:return e.next=13,this._getDefaultSensorsMask();case 13:return e.next=15,this._getAvailableSensors();case 15:this._onOpened(),t&&this.start();case 17:case"end":return e.stop()}},e,this)})),function(){return l.apply(this,arguments)})},{key:"close",value:(c=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.opened){e.next=2;break}throw new Error("Device cannot be closed because it is not open");case 2:return e.next=4,this._stopMeasurements();case 4:return e.next=6,this._sendCommand(commands.DISCONNECT);case 6:return e.abrupt("return",this._disconnect());case 7:case"end":return e.stop()}},e,this)})),function(){return c.apply(this,arguments)})},{key:"enableDefaultSensors",value:function(){for(var e=1,t=0;t<32;++t){if((this.defaultSensorsMask&e)===e){var n=this.getSensor(t);n&&n.setEnabled(!0)}e<<=1}}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this.sensors.filter(function(e){return e.enabled});0===t.length&&(this.enableDefaultSensors(),t=this.sensors.filter(function(e){return e.enabled})),t.forEach(function(e){return e.clear()}),e&&(this.measurementPeriod=e),this._startMeasurements()}},{key:"stop",value:function(){this._stopMeasurements()}},{key:"getSensor",value:function(e){return this.sensors.find(function(t){return t.number===e})}},{key:"_connect",value:(u=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.device.setup({onClosed:function(){return t._onClosed()},onResponse:function(e){return t._handleResponse(e)}}).then(function(){t.writeQueue=[],t.deviceWriteInterval=setInterval(function(){if(t.writeQueue&&t.writeQueue.length>0){var e=t.writeQueue[0];e.written||(t._writeToDevice(e.buffer),e.written=!0)}},10)}));case 1:case"end":return e.stop()}},e,this)})),function(){return u.apply(this,arguments)})},{key:"_disconnect",value:(s=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return clearInterval(this.deviceWriteInterval),e.abrupt("return",this.device.close());case 2:case"end":return e.stop()}},e,this)})),function(){return s.apply(this,arguments)})},{key:"_init",value:function(){return this.collecting=!1,this.rollingCounter=255,this._sendCommand(commands.INIT)}},{key:"_handleResponse",value:function(e){if(log("command notified: ".concat(bufferToHex(e.buffer))),this.remainingResponseLegnth>0){if(this.remainingResponseLegnth-=e.buffer.byteLength,this.response=new DataView(appendBuffer(this.response.buffer,e.buffer.slice(0))),this.remainingResponseLegnth>0)return}else this.response=e;var t=this.response.getUint8(1);if(t>this.response.buffer.byteLength)this.remainingResponseLegnth=t-this.response.buffer.byteLength;else switch(log("handle command: ".concat(bufferToHex(this.response.buffer))),this.response.getUint8(0)){case responseType.MEASUREMENT:this._processMeasurements(this.response);break;default:var n=this.response.getUint8(4),r=this.response.getUint8(5),a=new DataView(this.response.buffer,6);this._resolveWriteCommand(n,r,a),this.remainingResponseLegnth=0,this.response=null}}},{key:"_getSensorsWithMask",value:function(e){for(var t=[],n=1,r=0;r<32;++r){if((e&n)===n){var a=this.getSensor(r);a&&(t.push(a),log("available: [".concat(e,"] ").concat(t[t.length-1].number)))}n<<=1}return t}},{key:"_processMeasurements",value:function(e){var t=[],n=!0,r=0,a=0,o=e.getUint8(4);switch(o){case measurementType.NORMAL_REAL32:t=this._getSensorsWithMask(e.getUint16(5,!0)),r=e.getUint8(7,!0),a=9;break;case measurementType.WIDE_REAL32:t=this._getSensorsWithMask(e.getUint32(5,!0)),r=e.getUint8(9,!0),a=11;break;case measurementType.APERIODIC_REAL32:case measurementType.SINGLE_CHANNEL_REAL32:t[0]=this.getSensor(e.getUint8(6)),r=e.getUint8(7,!0),a=8;break;case measurementType.APERIODIC_INT32:case measurementType.SINGLE_CHANNEL_INT32:t[0]=this.getSensor(e.getUint8(6)),r=e.getUint8(7,!0),a=8,n=!1;break;case measurementType.START_TIME:case measurementType.DROPPED:case measurementType.PERIOD:log("Purposely Ignoring packet type: ".concat(o));break;default:log("Unknown packet type: ".concat(o))}for(var i=0;i<r;++i)for(var s=0;s<t.length;++s)n?t[s].setValue(e.getFloat32(a,!0),this.keepValues):t[s].setValue(e.getInt32(a,!0),this.keepValues),a+=4}},{key:"_resolveWriteCommand",value:function(e,t,n){var r=this.writeQueue.find(function(n){return n.command===e&&n.rollingCounter===t});r&&(r.resolve(n),this.writeQueue=this.writeQueue.filter(function(e){return e!==r}))}},{key:"_onOpened",value:function(){log("opened"),this.opened=!0,this.emit("device-opened")}},{key:"_onClosed",value:function(){log("closed"),this.opened=!1,this.emit("device-closed")}},{key:"_decRollingCounter",value:function(){return this.rollingCounter-=1,this.rollingCounter}},{key:"_calculateChecksum",value:function(e){for(var t=e[1],n=-1*e[3],r=0;r<t;++r)n+=e[r],n&=255;return n<0||n>255?(log("Checksum failed!"),0):n}},{key:"_sendCommand",value:function(e){var t=new Uint8Array(commands.HEADER.byteLength+e.byteLength);return t.set(new Uint8Array(commands.HEADER),0),t.set(new Uint8Array(e),commands.HEADER.byteLength),t[1]=t.length,t[2]=this._decRollingCounter(),t[3]=this._calculateChecksum(t),this._queueWriteCommand(t)}},{key:"_writeToDevice",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=0,a=t.length;case 2:if(!(a>0)){e.next=14;break}return e.prev=3,a>this.device.maxPacketLength?(n=t.subarray(r,r+this.device.maxPacketLength),a-=this.device.maxPacketLength,r+=this.device.maxPacketLength):(n=t.subarray(r,r+a),a=0),e.next=7,this.device.writeCommand(n);case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),log("Write Failure: ".concat(e.t0));case 12:e.next=2;break;case 14:case"end":return e.stop()}},e,this,[[3,9]])})),function(e){return i.apply(this,arguments)})},{key:"_queueWriteCommand",value:function(e){var t=this;return log("command queued: ".concat(bufferToHex(e))),new Promise(function(n,r){t.writeQueue.push({command:e[4],rollingCounter:e[2],buffer:e,written:!1,resolve:n,reject:r}),setTimeout(function(){t.writeQueue=t.writeQueue.filter(function(t){return t.command===e[4]&&t.rollingCounter!==e[2]}),r(new Error("write command timed out after 5s. Command: ".concat(e[4].toString(16)," Rolling Counter: ").concat(e[2].toString(16))))},5e3)})}},{key:"_getStatus",value:(o=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sendCommand(commands.GET_STATUS);case 2:return t=e.sent,n={masterFirmwareVersion:"".concat(t.getUint8(2),".").concat(t.getUint8(3)),bleFirmwareVersion:"".concat(t.getUint8(6),".").concat(t.getUint8(9)),battery:t.getUint8(10),chargingStatus:"".concat(t.getUint8(11))},e.abrupt("return",n);case 5:case"end":return e.stop()}},e,this)})),function(){return o.apply(this,arguments)})},{key:"_getAvailableSensors",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sendCommand(commands.GET_SENSOR_IDS).then(function(e){r.availableSensors=e.getUint32(0,!0),log("Get Available Sensors Returned ".concat(r.availableSensors))});case 2:t=1,n=0;case 4:if(!(n<31)){e.next=12;break}if((this.availableSensors&t)!==t){e.next=8;break}return e.next=8,this._getSensorInfo(n);case 8:t<<=1;case 9:++n,e.next=4;break;case 12:case"end":return e.stop()}},e,this)})),function(){return a.apply(this,arguments)})},{key:"_getDefaultSensorsMask",value:function(){var e=this;return this._sendCommand(commands.GET_DEFAULT_SENSORS_MASK).then(function(t){e.defaultSensorsMask=t.getUint32(0,!0),log("Default Sensors:"),dir(e)})}},{key:"_getDeviceInfo",value:function(){var e=this;return this._sendCommand(commands.GET_INFO).then(function(t){var n=new _TextDecoder("utf-8");e.orderCode=n.decode(new Uint8Array(t.buffer,6,16).filter(nonZero)),e.serialNumber=n.decode(new Uint8Array(t.buffer,22,16).filter(nonZero)),e.name=n.decode(new Uint8Array(t.buffer,38,32).filter(nonZero)),log("Device Info:"),dir(e)})}},{key:"_getSensorInfo",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(n=new Uint8Array(commands.GET_SENSOR_INFO))[1]=t,e.abrupt("return",this._sendCommand(n).then(function(e){var t=e.getUint32(2,!0);if(t>0){var n=new _TextDecoder("utf-8"),a=new MeasurementInfo({type:e.getUint8(6),mode:e.getUint8(7),minValue:e.getFloat64(108,!0),maxValue:e.getFloat64(116,!0),uncertainty:e.getFloat64(100,!0),minPeriod:e.getUint32(124,!0)/1e3,maxPeriod:((e.getUint32(132,!0)<<32)+e.getUint32(128,!0))/1e3,typicalPeriod:e.getUint32(136,!0)/1e3,granularity:e.getUint32(140,!0)/1e3}),o=new SensorSpecs({number:e.getUint8(0),name:n.decode(new Uint8Array(e.buffer,14,60).filter(nonZero)),unit:n.decode(new Uint8Array(e.buffer,74,32).filter(nonZero)),mutalExclusionMask:e.getUint32(144,!0),measurementInfo:a,sensorId:t}),i=new Sensor(o);log("Get Sensor Info Returned"),dir(i),r.sensors.push(i),i.on("state-changed",function(){log("Sensor Restart: ".concat(i.number)),i.enabled&&(r.measurementPeriod=i.specs.measurementInfo.typicalPeriod,r.sensors.forEach(function(e){if(i.number!==e.number&&e.enabled){var t=1<<e.number;(t&i.specs.mutalExclusionMask)===t?e.enabled=!1:e.specs.measurementInfo.typicalPeriod>r.measurementPeriod&&(r.measurementPeriod=e.specs.measurementInfo.typicalPeriod)}})),r._restartMeasurements()})}}));case 3:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"_restartMeasurements",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.collecting,!this.collecting){e.next=10;break}return e.prev=2,e.next=5,this._stopMeasurements();case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),console.error(e.t0);case 10:if(this.collecting||!t){e.next=19;break}return e.prev=11,e.next=14,this._startMeasurements();case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(11),console.error(e.t1);case 19:case"end":return e.stop()}},e,this,[[2,7],[11,16]])})),function(){return n.apply(this,arguments)})},{key:"_setMeasurementPeriod",value:function(e){var t=new Uint8Array(commands.SET_MEASUREMENT_PERIOD),n=1e3*this.minMeasurementPeriod;return e<n&&(e=n),log("MeasurementPeriod: ".concat(e)),t[3]=e>>0&255,t[4]=e>>8&255,t[5]=e>>16&255,t[6]=e>>24&255,this._sendCommand(t)}},{key:"_getEnabledChannelMask",value:function(){var e=0;return this.sensors.filter(function(e){return e.enabled}).forEach(function(t){e+=1<<t.number}),e}},{key:"_startMeasurements",value:function(){var e=this;return this._setMeasurementPeriod(1e3*this.measurementPeriod).then(function(){var t=e._getEnabledChannelMask();log("ChannelMask: ".concat(t));var n=new Uint8Array(commands.START_MEASUREMENTS);return n[3]=t>>0&255,n[4]=t>>8&255,n[5]=t>>16&255,n[6]=t>>24&255,e._sendCommand(n).then(function(t){0===t.getUint8(0)&&(e.collecting=!0,e.emit("measurements-started"))})})}},{key:"_stopMeasurements",value:function(){var e=this;return this._sendCommand(commands.STOP_MEASUREMENTS).then(function(t){0===t.getUint8(0)&&(e.collecting=!1,e.emit("measurements-stopped"))})}}]),t}(),SERVICE="d91714ef-28b9-4f91-ba16-f0d9a604f112",COMMAND_CHARACTERISTIC="f4bf14a6-c7d5-4b6d-8aa8-df1a7c83adcb",RESPONSE_CHARACTERISTIC="b41e6675-a329-40e0-aa01-44d2f444babe",WebBluetoothDeviceAdapter=function(){function e(t){_classCallCheck(this,e),this.webBluetoothNativeDevice=t,this.maxPacketLength=20,this.deviceCommand=null,this.deviceResponse=null}var t,n,r;return _createClass(e,[{key:"writeCommand",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceCommand.writeValue(t));case 1:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"setup",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,o,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.onClosed,r=t.onResponse,this.webBluetoothNativeDevice.addEventListener("gattserverdisconnected",n),e.prev=2,e.next=5,this.webBluetoothNativeDevice.gatt.connect();case 5:return a=e.sent,e.next=8,a.getPrimaryService(SERVICE);case 8:return o=e.sent,e.next=11,o.getCharacteristics();case 11:e.sent.forEach(function(e){switch(e.uuid){case COMMAND_CHARACTERISTIC:i.deviceCommand=e;break;case RESPONSE_CHARACTERISTIC:i.deviceResponse=e,i.deviceResponse.addEventListener("characteristicvaluechanged",function(e){var t=e.target.value;r(t)}),i.deviceResponse.startNotifications();break;default:log("No case found for ".concat(e.uuid))}}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),console.error(e.t0);case 18:if(this.deviceCommand&&this.deviceResponse){e.next=20;break}throw new Error("Expected command and response characteristics not found");case 20:case"end":return e.stop()}},e,this,[[2,15]])})),function(e){return n.apply(this,arguments)})},{key:"close",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.webBluetoothNativeDevice.gatt.disconnect());case 1:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"godirectAdapter",get:function(){return!0}}]),e}(),WebUsbDeviceAdapter=function(){function e(t){_classCallCheck(this,e),this.webUsbNativeDevice=t,this.onResponse=null,this.maxPacketLength=64}var t,n,r;return _createClass(e,[{key:"writeCommand",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Uint8Array([t.byteLength].concat(_toConsumableArray(t))),r=this.webUsbNativeDevice.collections[0].inputReports[0].reportId,e.abrupt("return",this.webUsbNativeDevice.sendReport(r,n));case 3:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"setup",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.onClosed,n=t.onResponse,e.next=3,this.webUsbNativeDevice.open();case 3:this.onResponse=n,this.webUsbNativeDevice.oninputreport=function(e){var t=new DataView(e.data.buffer.slice(1));r.onResponse(t)};case 5:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"close",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)})},{key:"godirectAdapter",get:function(){return!0}}]),e}(),godirect={createDevice:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,o,i,s,u,c,l,h=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=h.length>1&&void 0!==h[1]?h[1]:{},r=n.open,a=void 0===r||r,o=n.startMeasurements,i=void 0===o||o,s=n.bluetooth,u=void 0===s||s,(c=t).godirectAdapter||(c=u?new WebBluetoothDeviceAdapter(t):new WebUsbDeviceAdapter(t)),l=new Device(c),!a){e.next=14;break}return e.prev=5,e.next=8,l.open(i);case 8:e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(5),console.error(e.t0),new Error("Device Open Failed [".concat(e.t0,"]"));case 14:return e.abrupt("return",l);case 15:case"end":return e.stop()}},e,null,[[5,10]])}));return function(t){return e.apply(this,arguments)}}(),selectDevice:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=!(a.length>0&&void 0!==a[0])||a[0])){e.next=9;break}if(navigator.bluetooth){e.next=4;break}return e.abrupt("return",Promise.reject(new Error("No Web Bluetooth support.")));case 4:return e.next=6,navigator.bluetooth.requestDevice({filters:[{namePrefix:"GDX"}],optionalServices:["d91714ef-28b9-4f91-ba16-f0d9a604f112"]});case 6:n=e.sent,e.next=15;break;case 9:if(navigator.hid){e.next=11;break}return e.abrupt("return",Promise.reject(new Error("No Web HID support.")));case 11:return e.next=13,navigator.hid.requestDevice({filters:[{vendorId:2295,productId:16}]});case 13:r=e.sent,n=r[0];case 15:return e.abrupt("return",godirect.createDevice(n,{bluetooth:t}));case 16:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}()};module.exports=godirect;
